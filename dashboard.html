<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRE Prep - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .dashboard-header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .user-greeting {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-btn.secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .skill-category {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .skill-category h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .skill-bar-container {
            margin-bottom: 20px;
        }

        .skill-name {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .skill-bar-bg {
            width: 100%;
            height: 25px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .skill-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .skill-bar-fill.weak {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        }

        .skill-bar-fill.medium {
            background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
        }

        .skill-bar-fill.strong {
            background: linear-gradient(90deg, #27ae60 0%, #229954 100%);
        }

        .recent-sessions {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .recent-sessions h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .session-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-info {
            flex: 1;
        }

        .session-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .session-score {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .session-details {
            font-size: 14px;
            color: #7f8c8d;
        }

        .insights-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .insights-panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .insight-item {
            padding: 15px;
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .insight-item strong {
            color: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .topics-menu {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .topics-menu h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .topic-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .topic-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .topic-icon {
            font-size: 32px;
        }

        .topic-name {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .skills-grid {
                grid-template-columns: 1fr;
            }

            .nav-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä Your Learning Dashboard</h1>
            <div class="user-greeting">
                Welcome back, <strong><span id="username-display"></span></strong>!
            </div>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn primary">üìù Start New Quiz</a>
                <a href="#" onclick="logout()" class="nav-btn secondary">üö™ Logout</a>
            </div>
        </div>

        <!-- Math Topics Menu -->
        <div class="topics-menu">
            <h2>üìê Practice by Math Topic</h2>
            <div class="topics-grid">
                <button class="topic-btn" onclick="startTopicQuiz('number_theory')">
                    <span class="topic-icon">üî¢</span>
                    <span class="topic-name">Number Theory</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('percents')">
                    <span class="topic-icon">%</span>
                    <span class="topic-name">Percents</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('absolute_value')">
                    <span class="topic-icon">|x|</span>
                    <span class="topic-name">Absolute Value</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('coordinate_geometry')">
                    <span class="topic-icon">üìä</span>
                    <span class="topic-name">Coordinate Geometry</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('standard_deviation')">
                    <span class="topic-icon">œÉ</span>
                    <span class="topic-name">Standard Deviation</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('probability')">
                    <span class="topic-icon">üé≤</span>
                    <span class="topic-name">Probability</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('combinatorics')">
                    <span class="topic-icon">üîÄ</span>
                    <span class="topic-name">Combinatorics</span>
                </button>
                <button class="topic-btn" onclick="startTopicQuiz('sequences')">
                    <span class="topic-icon">‚Üí</span>
                    <span class="topic-name">Sequences & Progressions</span>
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            Loading your progress...
        </div>

        <div id="error-container"></div>

        <div id="dashboard-content" style="display: none;">
            <!-- Overall Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="total-questions">0</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="average-score">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="study-streak">0</div>
                    <div class="stat-label">Study Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="improvement">+0%</div>
                    <div class="stat-label">Recent Trend</div>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="chart-container">
                <h2>üìà Score Progress Over Time</h2>
                <div class="chart-wrapper">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- Skills Breakdown -->
            <div class="skills-grid">
                <div class="skill-category">
                    <h3>üìê Quantitative Skills</h3>
                    <div id="quant-skills"></div>
                </div>
                <div class="skill-category">
                    <h3>üìö Verbal Skills</h3>
                    <div id="verbal-skills"></div>
                </div>
            </div>

            <!-- Skill Distribution Chart -->
            <div class="chart-container">
                <h2>üéØ Skills Mastery Distribution</h2>
                <div class="chart-wrapper">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>

            <!-- Recent Sessions -->
            <div class="recent-sessions">
                <h2>üìù Recent Quiz Sessions</h2>
                <div id="recent-sessions-list"></div>
            </div>

            <!-- Personalized Insights -->
            <div class="insights-panel">
                <h2>üí° Personalized Insights & Recommendations</h2>
                <div id="insights-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5001/api';
        const userId = localStorage.getItem('user_id');
        const username = localStorage.getItem('username');

        if (!userId) {
            window.location.href = 'auth.html';
        }

        document.getElementById('username-display').textContent = username || 'User';

        let progressChart = null;
        let skillsChart = null;

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/profile/${userId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }

                const data = await response.json();
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

                // Populate dashboard
                populateStats(data.profile, data.recent_sessions);
                populateSkills(data.skills);
                populateRecentSessions(data.recent_sessions);
                generateInsights(data);
                createProgressChart(data.recent_sessions);
                createSkillsChart(data.skills);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-container').innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> Could not load your progress data. Please try again later.
                    </div>
                `;
            }
        }

        function populateStats(profile, sessions) {
            // Total questions
            document.getElementById('total-questions').textContent = 
                profile?.total_questions_answered || 0;

            // Average score
            const avgScore = profile?.average_score || 0;
            document.getElementById('average-score').textContent = 
                Math.round(avgScore) + '%';

            // Study streak (number of sessions)
            document.getElementById('study-streak').textContent = 
                sessions?.length || 0;

            // Calculate improvement trend (compare last 3 vs previous 3)
            if (sessions && sessions.length >= 3) {
                const recent = sessions.slice(0, 3);
                const recentAvg = recent.reduce((sum, s) => sum + (s.score / s.total_questions * 100), 0) / recent.length;
                
                if (sessions.length >= 6) {
                    const older = sessions.slice(3, 6);
                    const olderAvg = older.reduce((sum, s) => sum + (s.score / s.total_questions * 100), 0) / older.length;
                    const improvement = recentAvg - olderAvg;
                    document.getElementById('improvement').textContent = 
                        (improvement > 0 ? '+' : '') + Math.round(improvement) + '%';
                    document.getElementById('improvement').style.color = 
                        improvement > 0 ? '#27ae60' : (improvement < 0 ? '#e74c3c' : '#7f8c8d');
                } else {
                    document.getElementById('improvement').textContent = 'N/A';
                }
            }
        }

        function populateSkills(skills) {
            const quantContainer = document.getElementById('quant-skills');
            const verbalContainer = document.getElementById('verbal-skills');

            quantContainer.innerHTML = '';
            verbalContainer.innerHTML = '';

            if (!skills || skills.length === 0) {
                quantContainer.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No data yet. Complete a quiz to see your skills breakdown!</p>';
                verbalContainer.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No data yet. Complete a quiz to see your skills breakdown!</p>';
                return;
            }

            skills.forEach(skill => {
                const percentage = skill.total_count > 0 
                    ? Math.round((skill.correct_count / skill.total_count) * 100) 
                    : 0;
                
                const skillName = skill.skill_name
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());

                let barClass = '';
                if (percentage >= 75) barClass = 'strong';
                else if (percentage >= 50) barClass = 'medium';
                else barClass = 'weak';

                const skillHTML = `
                    <div class="skill-bar-container">
                        <div class="skill-name">
                            <span>${skillName}</span>
                            <span>${skill.correct_count}/${skill.total_count}</span>
                        </div>
                        <div class="skill-bar-bg">
                            <div class="skill-bar-fill ${barClass}" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    </div>
                `;

                if (skill.skill_type === 'verbal') {
                    verbalContainer.innerHTML += skillHTML;
                } else {
                    quantContainer.innerHTML += skillHTML;
                }
            });

            if (quantContainer.innerHTML === '') {
                quantContainer.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No quantitative data yet.</p>';
            }
            if (verbalContainer.innerHTML === '') {
                verbalContainer.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No verbal data yet.</p>';
            }
        }

        function populateRecentSessions(sessions) {
            const container = document.getElementById('recent-sessions-list');

            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No quiz sessions yet. Start your first quiz to track your progress!</p>';
                return;
            }

            container.innerHTML = '';

            sessions.forEach(session => {
                const percentage = Math.round((session.score / session.total_questions) * 100);
                const date = new Date(session.completed_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                container.innerHTML += `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-date">${date}</div>
                            <div class="session-details">
                                ${session.score}/${session.total_questions} correct ‚Ä¢ 
                                Ended on ${session.difficulty_end} difficulty
                            </div>
                        </div>
                        <div class="session-score">${percentage}%</div>
                    </div>
                `;
            });
        }

        function generateInsights(data) {
            const container = document.getElementById('insights-list');
            const insights = [];

            const profile = data.profile;
            const skills = data.skills || [];
            const sessions = data.recent_sessions || [];

            // Insight 1: Overall performance
            if (profile && profile.average_score >= 75) {
                insights.push(`<div class="insight-item">
                    <strong>üåü Excellent Progress!</strong> Your average score of ${Math.round(profile.average_score)}% shows strong performance. You're well-prepared for the GRE!
                </div>`);
            } else if (profile && profile.average_score >= 50) {
                insights.push(`<div class="insight-item">
                    <strong>üìà Good Foundation!</strong> You're scoring ${Math.round(profile.average_score)}% on average. Focus on your weak areas to push past 75%.
                </div>`);
            } else if (profile && profile.average_score > 0) {
                insights.push(`<div class="insight-item">
                    <strong>üí™ Keep Building!</strong> Your ${Math.round(profile.average_score)}% average shows you're learning. Consistent practice will boost your scores quickly.
                </div>`);
            }

            // Insight 2: Strongest skill
            const strongestSkill = skills.reduce((best, skill) => {
                const percent = skill.total_count > 0 ? (skill.correct_count / skill.total_count) : 0;
                const bestPercent = best && best.total_count > 0 ? (best.correct_count / best.total_count) : 0;
                return percent > bestPercent ? skill : best;
            }, null);

            if (strongestSkill && strongestSkill.total_count >= 3) {
                const percent = Math.round((strongestSkill.correct_count / strongestSkill.total_count) * 100);
                const skillName = strongestSkill.skill_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                insights.push(`<div class="insight-item">
                    <strong>üéØ Your Strength:</strong> ${skillName} is your strongest area at ${percent}%. This is a solid foundation to build on!
                </div>`);
            }

            // Insight 3: Weakest skill (needs improvement)
            const weakestSkill = skills.filter(s => s.total_count >= 3).reduce((worst, skill) => {
                const percent = skill.total_count > 0 ? (skill.correct_count / skill.total_count) : 1;
                const worstPercent = worst && worst.total_count > 0 ? (worst.correct_count / worst.total_count) : 1;
                return percent < worstPercent ? skill : worst;
            }, null);

            if (weakestSkill && (weakestSkill.correct_count / weakestSkill.total_count) < 0.6) {
                const percent = Math.round((weakestSkill.correct_count / weakestSkill.total_count) * 100);
                const skillName = weakestSkill.skill_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                insights.push(`<div class="insight-item">
                    <strong>üéì Focus Area:</strong> ${skillName} needs attention (${percent}%). Dedicate extra practice time here for the biggest score gains.
                </div>`);
            }

            // Insight 4: Recent trend
            if (sessions.length >= 3) {
                const recentScores = sessions.slice(0, 3).map(s => (s.score / s.total_questions) * 100);
                const avgRecent = recentScores.reduce((a, b) => a + b, 0) / recentScores.length;
                
                const isImproving = recentScores[0] > recentScores[2];
                
                if (isImproving) {
                    insights.push(`<div class="insight-item">
                        <strong>üìä Upward Trend!</strong> Your recent scores show improvement. Keep up the momentum with regular practice.
                    </div>`);
                } else {
                    insights.push(`<div class="insight-item">
                        <strong>üîÑ Stay Consistent:</strong> Your scores have varied recently. Try practicing at the same time each day for better retention.
                    </div>`);
                }
            }

            // Insight 5: Practice recommendation
            if (profile && profile.total_questions_answered < 50) {
                insights.push(`<div class="insight-item">
                    <strong>‚è∞ Practice More:</strong> You've completed ${profile.total_questions_answered} questions. Aim for 50+ to get a comprehensive skill assessment.
                </div>`);
            }

            // Display insights
            if (insights.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Complete more quizzes to unlock personalized insights!</p>';
            } else {
                container.innerHTML = insights.join('');
            }
        }

        function createProgressChart(sessions) {
            if (!sessions || sessions.length === 0) return;

            const ctx = document.getElementById('progressChart');
            
            // Sort sessions by date (oldest first for the chart)
            const sortedSessions = [...sessions].reverse();

            const labels = sortedSessions.map((s, i) => `Quiz ${i + 1}`);
            const scores = sortedSessions.map(s => Math.round((s.score / s.total_questions) * 100));

            if (progressChart) {
                progressChart.destroy();
            }

            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score (%)',
                        data: scores,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSkillsChart(skills) {
            if (!skills || skills.length === 0) return;

            const ctx = document.getElementById('skillsChart');

            const skillLabels = skills.map(s => 
                s.skill_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            );
            const skillPercentages = skills.map(s => 
                s.total_count > 0 ? Math.round((s.correct_count / s.total_count) * 100) : 0
            );

            const backgroundColors = skillPercentages.map(p => {
                if (p >= 75) return 'rgba(39, 174, 96, 0.7)';
                if (p >= 50) return 'rgba(243, 156, 18, 0.7)';
                return 'rgba(231, 76, 60, 0.7)';
            });

            if (skillsChart) {
                skillsChart.destroy();
            }

            skillsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skillLabels,
                    datasets: [{
                        label: 'Mastery (%)',
                        data: skillPercentages,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function logout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('username');
            window.location.href = 'auth.html';
        }

        function startTopicQuiz(topic) {
            // Save selected topic to localStorage
            localStorage.setItem('selected_topic', topic);
            // Redirect to quiz page
            window.location.href = 'index.html';
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>